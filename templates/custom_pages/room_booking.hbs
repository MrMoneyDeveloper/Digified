<!-- ROOM_BOOKING_TEMPLATE: 2026-02-10 -->
<link rel="stylesheet" href="{{asset 'room-bookings.css'}}">
<script>
  window.ROOM_BOOKING_CFG = {
    baseUrl: "{{settings.room_booking_api_url}}",
    apiKey: "{{settings.room_booking_api_key}}"
  };

  // Logging setup
  window.RoomBookingLogger = {
    logs: [],
    isDev: window.location.hostname.includes("localhost") || window.location.hostname.includes("zendesk.com"),

    log: function(level, message, metadata) {
      const timestamp = new Date().toISOString();
      const entry = {
        timestamp: timestamp,
        level: level,
        message: message,
        metadata: metadata || {},
        url: window.location.href,
        userAgent: navigator.userAgent
      };
      this.logs.push(entry);

      // Console output
      const style = level === "ERROR" ? "color: red; font-weight: bold;"
        : level === "WARN" ? "color: orange; font-weight: bold;"
        : "color: blue;";
      console.log(`%c[RoomBooking ${level}] ${timestamp}`, style, message, metadata);

      // Send to backend if configured (optional)
      if (this.isDev === false && window.ROOM_BOOKING_LOG_ENDPOINT) {
        fetch(window.ROOM_BOOKING_LOG_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(entry)
        }).catch(() => {});
      }
    },

    info: function(message, metadata) { this.log("INFO", message, metadata); },
    warn: function(message, metadata) { this.log("WARN", message, metadata); },
    error: function(message, metadata) { this.log("ERROR", message, metadata); },

    export: function() {
      return JSON.stringify(this.logs, null, 2);
    }
  };

  // Log initial configuration
  window.RoomBookingLogger.info("Room Booking initialized", {
    configBaseUrl: window.ROOM_BOOKING_CFG.baseUrl,
    configHasApiKey: !!window.ROOM_BOOKING_CFG.apiKey,
    themeSettings: {
      hasUrl: !!("{{settings.room_booking_api_url}}" || "").trim(),
      hasKey: !!("{{settings.room_booking_api_key}}" || "").trim()
    }
  });
</script>

<section class="room-bookings">
  <div class="container">
    <div class="rb-hero">
      <h1>Book Meeting Room</h1>
      <p class="rb-intro">Select a date to view available meeting room slots. Click on time blocks to book.</p>
    </div>

    {{#if signed_in}}
      <div
        id="room-booking-root"
        class="rb-app"
        data-room-booking-version="v2"
        data-room-base-url="{{settings.room_booking_api_url}}"
        data-room-api-key="{{settings.room_booking_api_key}}"
        data-room-config-url="{{settings.room_booking_api_url}}"
        data-room-config-key-present="{{#if settings.room_booking_api_key}}true{{else}}false{{/if}}"
      >
        <div id="room-booking-alert" class="rb-alert" role="status" aria-live="polite" hidden></div>

        <form id="room-booking-filters" class="rb-filters" autocomplete="off">
          <div class="rb-field">
            <label for="room-date">Select Date</label>
            <input class="form-control" id="room-date" name="date" type="date" required>
          </div>
          <div class="rb-actions">
            <button class="btn btn-primary" id="room-load" type="submit">Load Availability</button>
            <button class="btn btn-secondary" id="room-reset" type="button">Reset</button>
          </div>
        </form>

        <div id="room-booking-loading" class="rb-loading" hidden>
          <span class="rb-spinner" aria-hidden="true"></span>
          <span>Loading room availability...</span>
        </div>

        <!-- NEW: Visual Timeline Calendar -->
        <div id="room-timeline-calendar" class="rb-timeline-calendar" hidden>
          <div class="rb-timeline-header">
            <h3 id="rb-selected-date-display">Select a date above</h3>
          </div>
          <div class="rb-timeline-grid" id="room-timeline-grid">
            <!-- Generated dynamically by JavaScript -->
          </div>
          <div class="rb-legend">
            <span class="rb-legend-item"><span class="rb-legend-color rb-available"></span> Available</span>
            <span class="rb-legend-item"><span class="rb-legend-color rb-booked"></span> Booked</span>
          </div>
        </div>

        <!-- Booking Modal -->
        <div id="room-booking-modal" class="rb-modal" aria-hidden="true" hidden>
          <div class="rb-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="room-booking-modal-title">
            <div class="rb-modal-header">
              <h2 class="rb-modal-title" id="room-booking-modal-title">Book Meeting Room</h2>
              <button class="rb-modal-close" type="button" id="room-booking-modal-close" aria-label="Close">&times;</button>
            </div>
            <div class="rb-modal-body">
              <div id="room-booking-session-summary" class="rb-session-summary"></div>
              <form id="room-booking-form" class="rb-form">
                <input id="room-booking-slot-id" type="hidden">
                <div class="rb-form-grid">
                  <div class="rb-field">
                    <label for="room-booking-requester-name">Your Name</label>
                    <input class="form-control" id="room-booking-requester-name" name="requester_name" type="text" readonly disabled required style="background-color: #f5f5f5; cursor: not-allowed;">
                  </div>
                  <div class="rb-field">
                    <label for="room-booking-requester-email">Your Email</label>
                    <input class="form-control" id="room-booking-requester-email" name="requester_email" type="email" readonly disabled required style="background-color: #f5f5f5; cursor: not-allowed;">
                  </div>
                  <div class="rb-field rb-full-width">
                    <label for="room-booking-notes">Additional Notes</label>
                    <textarea class="form-control" id="room-booking-notes" name="notes" rows="3" placeholder="Any special requirements?"></textarea>
                  </div>
                </div>
                <div class="rb-modal-actions">
                  <button class="btn btn-primary" id="room-booking-submit" type="submit">Book Now</button>
                  <button class="btn btn-secondary" id="room-booking-modal-cancel" type="button">Cancel</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    {{else}}
      <div class="rb-signed-out">
        <p>Please sign in to view and book meeting rooms.</p>
        <a class="btn btn-primary" href="/hc/en-us/signin">Sign in</a>
      </div>
    {{/if}}
  </div>
</section>

<script src="{{asset 'room-bookings-calendar.js'}}" defer></script>
