<section class="dbpo-request digify-form-page">
  <div class="container digify-shell">
    <div class="row justify-content-center">
      <div class="col-12 col-xxl-10">
        <div class="form-header digify-form-hero">
          <h1>{{t 'submit_a_request'}}</h1>
          <p class="form-required-note">Fields marked with an asterisk (*) are required.</p>
        </div>
        <div class="digify-form-card">
          <div id="new-request-form"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<script type="module">
  import { renderNewRequestForm } from "new-request-form";

  const container = document.getElementById("new-request-form");

  const settings = {{json settings}};

  const props = {
    requestForm: {{json new_request_form}},
    newRequestPath: {{json (page_path 'new_request')}},
    parentId: {{json parent.id}},
    parentIdPath: {{json parent.url}},
    locale: {{json help_center.locale}},
    baseLocale: {{json help_center.base_locale}},
    hasAtMentions: {{json help_center.at_mentions_enabled}},
    userRole: {{json user.role}},
    userId: {{json user.id}},
    brandId: {{json brand.id}},
    organizations: {{json user.organizations}},
    wysiwyg: true,
    answerBotModal: {
      answerBot: {{json answer_bot}},
      hasRequestManagement: {{json help_center.request_management_enabled}},
      isSignedIn: {{json signed_in}},
      helpCenterPath: {{json (page_path 'help_center')}},
      requestsPath: {{json (page_path 'requests')}},
      requestPath: {{json (page_path 'request' id=answer_bot.request_id)}}
    },
  };

  renderNewRequestForm(settings, props, container);

  const homePath = {{json (page_path 'help_center')}};
  const storageKey = "digifyRedirectAfterRequest";

  const getFormFields = (form) => {
    return Array.from(form.querySelectorAll("input, select, textarea")).filter((field) => {
      if (!field || field.disabled) return false;
      if ((field.type || "").toLowerCase() === "hidden") return false;
      if (field.closest("[hidden]")) return false;
      return true;
    });
  };

  const getFieldKey = (field) => field.id || field.name || "";

  const getFeedbackNode = (field) => {
    const key = getFieldKey(field);
    if (!key || !field.parentElement) return null;
    return Array.from(field.parentElement.querySelectorAll(".invalid-feedback")).find((node) => {
      return node.getAttribute("data-digify-feedback-for") === key;
    }) || null;
  };

  const ensureFeedbackNode = (field) => {
    const key = getFieldKey(field);
    if (!key) return null;
    const existing = getFeedbackNode(field);
    if (existing) return existing;

    const node = document.createElement("div");
    node.className = "invalid-feedback";
    node.setAttribute("data-digify-feedback-for", key);
    node.hidden = true;
    field.insertAdjacentElement("afterend", node);
    return node;
  };

  const setFieldInvalid = (field, message) => {
    field.classList.add("is-invalid");
    field.setAttribute("aria-invalid", "true");
    const feedback = ensureFeedbackNode(field);
    if (feedback) {
      feedback.textContent = message || field.validationMessage || "This field is required.";
      feedback.hidden = false;
    }
  };

  const clearFieldInvalid = (field) => {
    field.classList.remove("is-invalid");
    field.removeAttribute("aria-invalid");
    const feedback = getFeedbackNode(field);
    if (feedback) {
      feedback.textContent = "";
      feedback.hidden = true;
    }
  };

  const getFieldTopOffset = (field) => {
    if (!field || typeof field.getBoundingClientRect !== "function") {
      return Number.POSITIVE_INFINITY;
    }
    const rect = field.getBoundingClientRect();
    return rect.top + (window.scrollY || window.pageYOffset || 0);
  };

  const focusAndScrollToField = (field) => {
    if (!field) return;

    if (typeof field.focus === "function") {
      try {
        field.focus({ preventScroll: true });
      } catch (error) {
        field.focus();
      }
    }

    if (typeof field.scrollIntoView === "function") {
      field.scrollIntoView({
        behavior: "smooth",
        block: "center",
        inline: "nearest"
      });
    }
  };

  const ensureFormErrorSummary = (form) => {
    let summary = form.querySelector("[data-digify-form-error-summary]");
    if (!summary) {
      summary = document.createElement("div");
      summary.className = "alert alert-danger";
      summary.setAttribute("data-digify-form-error-summary", "true");
      summary.setAttribute("role", "alert");
      summary.hidden = true;
      form.prepend(summary);
    }
    return summary;
  };

  const validateForm = (form) => {
    const fields = getFormFields(form);
    const invalidFields = [];

    fields.forEach((field) => {
      if (typeof field.checkValidity !== "function") return;
      if (!field.checkValidity()) {
        setFieldInvalid(field, field.validationMessage);
        invalidFields.push(field);
      } else {
        clearFieldInvalid(field);
      }
    });

    invalidFields.sort((a, b) => getFieldTopOffset(a) - getFieldTopOffset(b));
    const firstInvalid = invalidFields.length ? invalidFields[0] : null;

    const summary = ensureFormErrorSummary(form);
    if (firstInvalid) {
      summary.textContent = "Please complete the highlighted required fields before submitting.";
      summary.hidden = false;
    } else {
      summary.textContent = "";
      summary.hidden = true;
    }

    return firstInvalid;
  };

  const armRedirect = (form) => {
    if (form.dataset.digifyRedirectHooked) return;
    form.dataset.digifyRedirectHooked = "true";

    const onFieldEdit = (event) => {
      const field = event.target;
      if (!field || typeof field.checkValidity !== "function") return;
      if (field.checkValidity()) {
        clearFieldInvalid(field);
      }
    };

    form.addEventListener("input", onFieldEdit, true);
    form.addEventListener("change", onFieldEdit, true);
    form.addEventListener("submit", (event) => {
      const firstInvalid = validateForm(form);
      if (firstInvalid) {
        event.preventDefault();
        event.stopPropagation();
        if (typeof event.stopImmediatePropagation === "function") {
          event.stopImmediatePropagation();
        }
        focusAndScrollToField(firstInvalid);
        if (typeof firstInvalid.reportValidity === "function") {
          firstInvalid.reportValidity();
        }
        return;
      }

      sessionStorage.setItem(
        storageKey,
        JSON.stringify({ target: homePath, timestamp: Date.now() })
      );
    }, true);
  };

  const removeSuggestions = () => {
    const suggestions = container.querySelector('[data-test-id="suggested-articles"]');
    if (suggestions) {
      suggestions.remove();
    }
  };

  const connect = () => {
    const form = container.querySelector("form");
    if (form) {
      armRedirect(form);
      removeSuggestions();
      observer.disconnect();
    }
  };

  const observer = new MutationObserver(connect);
  observer.observe(container, { childList: true, subtree: true });
  connect();
</script>
