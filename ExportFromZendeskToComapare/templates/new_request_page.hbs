<section class="dbpo-request">
  <div class="container">
    <div class="form-header">
      <h1>{{t 'submit_a_request'}}</h1>
      <p class="form-required-note">Fields marked with an asterisk (*) are required.</p>
    </div>
    <div id="new-request-form"></div>
  </div>
</section>

<script type="module">
  import { renderNewRequestForm } from "new-request-form";

  const container = document.getElementById("new-request-form");

  const settings = {{json settings}};

  const props = {
    requestForm: {{json new_request_form}},
    newRequestPath: {{json (page_path 'new_request')}},
    parentId: {{json parent.id}},
    parentIdPath: {{json parent.url}},
    locale: {{json help_center.locale}},
    baseLocale: {{json help_center.base_locale}},
    hasAtMentions: {{json help_center.at_mentions_enabled}},
    userRole: {{json user.role}},
    userId: {{json user.id}},
    brandId: {{json brand.id}},
    organizations: {{json user.organizations}},
    wysiwyg: true,
    answerBotModal: {
      answerBot: {{json answer_bot}},
      hasRequestManagement: {{json help_center.request_management_enabled}},
      isSignedIn: {{json signed_in}},
      helpCenterPath: {{json (page_path 'help_center')}},
      requestsPath: {{json (page_path 'requests')}},
      requestPath: {{json (page_path 'request' id=answer_bot.request_id)}}
    },
  };

  renderNewRequestForm(settings, props, container);

  const homePath = {{json (page_path 'help_center')}};
  const storageKey = "digifyRedirectAfterRequest";

  const armRedirect = (form) => {
    if (form.dataset.digifyRedirectHooked) return;
    form.dataset.digifyRedirectHooked = "true";
    form.addEventListener("submit", () => {
      sessionStorage.setItem(
        storageKey,
        JSON.stringify({ target: homePath, timestamp: Date.now() })
      );
    });
  };

  const removeSuggestions = () => {
    const suggestions = container.querySelector('[data-test-id="suggested-articles"]');
    if (suggestions) {
      suggestions.remove();
    }
  };

  const connect = () => {
    const form = container.querySelector("form");
    if (form) {
      armRedirect(form);
      removeSuggestions();
      observer.disconnect();
    }
  };

  const observer = new MutationObserver(connect);
  observer.observe(container, { childList: true, subtree: true });
  connect();
</script>
