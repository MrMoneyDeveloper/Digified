## Digified Zendesk Theme

The repository contains the working copy of the Digified Zendesk Guide theme. Edit the files under `templates/`, `assets/`, etc., then rebuild the distributable archive before uploading to Zendesk.

### Packaging

Zendeskâ€™s importer expects forward-slash paths inside the zip. Windows `Compress-Archive` writes backslash-separated entries, which causes missing-template errors (e.g., `templates/home_page.hbs`). Use the helper script instead:

```powershell
powershell -ExecutionPolicy Bypass -File .\package-theme.ps1
```

The script runs `tar -a -c -f digified-theme.zip assets settings templates translations script.js style.css manifest.json settings_schema.json`, ensuring the resulting `digified-theme.zip` is ready for import with POSIX-style paths. Use the `-ExecutionPolicy Bypass` flag if your PowerShell policy blocks local scripts.

### GitHub pull deployment

If Zendesk Guide is connected directly to GitHub (instead of ZIP upload), use this flow:

1. Bump `manifest.json` `version` on every deploy.
2. Commit and push to the Zendesk-connected branch.
3. In Zendesk Guide, click **Update from GitHub**.
4. Click **Publish**.
5. Verify `templates/document_head.hbs` `BUILD_MARKER` in page source to confirm the latest pull is live.

### Room booking setup

The room booking page relies on a Google Apps Script web app that returns available sessions and creates Zendesk tickets after a booking.

Calendar_API deployment:
- Deployment ID: `AKfycbxKZUHO8KiN6-oawtgTnXJy9yf2OPUT1hpnRgcrnygAB8SzMv3J5EylrhC4_Dgv0_dX`
- Web App URL: `https://script.google.com/macros/s/AKfycbxKZUHO8KiN6-oawtgTnXJy9yf2OPUT1hpnRgcrnygAB8SzMv3J5EylrhC4_Dgv0_dX/exec`

Apps Script properties (Project Settings > Script properties):
- `ZD_SUBDOMAIN`: Zendesk subdomain used for ticket creation.
- `ZD_EMAIL`: Zendesk agent email used to create tickets.
- `ZD_TOKEN`: Zendesk API token for ticket creation.
- `ROOM_BOOKING_API_KEY`: API key generated by the Apps Script `?action=init` endpoint.
- `TRAINING_CALENDAR_ID` (optional): Google Calendar ID for Meet event creation (`primary` is used by default).
- `TRAINING_DEFAULT_TZ` (optional): timezone for meeting creation (defaults to script timezone).
Add session rows to the Apps Script `SESSIONS` sheet for the date range you want to expose.

Zendesk theme settings (Guide Admin > Customize > Theme settings):
- Set `room_booking_api_url` to the Apps Script web app URL.
- Run `https://script.google.com/macros/s/AKfycbxKZUHO8KiN6-oawtgTnXJy9yf2OPUT1hpnRgcrnygAB8SzMv3J5EylrhC4_Dgv0_dX/exec?action=init` once, then copy `ROOM_BOOKING_API_KEY` from the Apps Script SETTINGS sheet.
- Set `room_booking_api_key` to that key.
- Set `room_booking_api_mode` to `jsonp` (default) or `fetch` depending on CORS support.
- Optional: set `room_booking_iframe_url` if you want to embed a full booking UI instead of the API flow.
- Optional: set `room_booking_internal_tag` if internal users need a specific tag to see booking links.

Note: The Apps Script handles Zendesk ticket creation internally, so the client does not call the Zendesk API directly.

Custom page setup:
- Create a Zendesk Guide custom page with slug `room_booking`.
- Assign the `room_booking` custom template (backed by `templates/custom_pages/room_booking.hbs`).
- The resulting URL should be `/hc/en-us/p/room_booking`.
- The template loads `assets/room-bookings-calendar.js` and `assets/room-bookings.css` for the booking UI.

Segmented home pages:
- Create a Zendesk Guide custom page with slug `home_internal` using `templates/custom_pages/home_internal.hbs`.
- Create a Zendesk Guide custom page with slug `home_tenant` using `templates/custom_pages/home_tenant.hbs`.
- `templates/home_page.hbs` redirects signed-in segmented users to these pages.
- Legacy `/hc/{locale}/room_booking` requests are redirected to `/hc/{locale}/p/room_booking` in `script.js`.

Validation checklist:
- Visit `https://cxe-internal.zendesk.com/hc/en-us/p/room_booking` and confirm the template loads.
- Click the "Book Room" nav link and confirm it routes to the same page.
- Use the default next-30-days range to load sessions and submit a booking.
- Submit one in-person-only booking and one in-person + remote booking and verify API responses.
- For remote bookings, verify `meet_link` is returned and included in the Zendesk ticket comment.
- Check page source for `ROOM_BOOKING_VERSION: 2026-02-10-06`.

### Troubleshooting JSONP errors

If you see `ReferenceError: roomJsonpCb_... is not defined`, it usually means the JSONP callback was removed or never loaded:
- The page did not load `assets/room-bookings-calendar.js` (stale ZIP upload or missing asset).
- Callback name mismatch: the room booking script uses `roomJsonpCb_*`, while the training booking script uses `calApiJsonpCb_*`. Loading the wrong file for a page will break the callback.
- The Apps Script response arrived after the timeout (the callback is cleaned up on timeout).

Why changes did not reflect even though the repo changed:
- The theme ZIP is built by `package-theme.ps1`, which only includes `assets`, `settings`, `templates`, `translations`, `script.js`, `style.css`, `manifest.json`, and `settings_schema.json`. Anything outside those paths is ignored.
- Apps Script code runs on Google servers; it is not part of the Zendesk theme ZIP.

What to do next:
- Verify the correct template loads the matching JS file (`assets/room-bookings-calendar.js` for room booking, `assets/training-bookings-calendar.js` for training booking).
- Rebuild and reupload the ZIP using `powershell -ExecutionPolicy Bypass -File .\\package-theme.ps1`.
- Confirm `room_booking_api_url` and `room_booking_api_key` are set in theme settings.

